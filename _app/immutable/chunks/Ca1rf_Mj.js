const p={backdrop:"Backdrop",primary:"Primary",thumbnail:"Thumb"},u={season:"Season",audio:"Audio",boxset:"BoxSet"};class d{config;constructor(e){this.config=e}getImageUrl(e,r,a=100,t=1080){const{baseUrl:n,accessToken:s}=this.config;return`${n.replace(/\/$/,"")}/Items/${e}/Images/${r}?quality=${a}&fillHeight=${t}&api_key=${s}`}async getVideoDetails(e){const{baseUrl:r,accessToken:a}=this.config,n=`${r.replace(/\/$/,"")}/Items/${e}?api_key=${a}`,s=await fetch(n);if(!s.ok)throw new Error("Failed to get video details");return s.json()}async getUsers(){const{baseUrl:e,accessToken:r}=this.config,a=e.replace(/\/$/,"");if(r){const n=`${a}/Users?api_key=${r}`,s=await fetch(n);if(s.ok)return s.json()}const t=await fetch(`${a}/Users/Public`);if(t.ok)return t.json();throw new Error("Failed to fetch users")}async getViews(e){const{baseUrl:r,accessToken:a}=this.config,n=`${r.replace(/\/$/,"")}/Users/${e}/Views?api_key=${a}`,s=await fetch(n);if(!s.ok)throw new Error("Failed to fetch user views");return s.json()}async authenticateUser(e,r){const{baseUrl:a}=this.config,n=`${a.replace(/\/$/,"")}/Users/AuthenticateByName`,s={"Content-Type":"application/json",Authorization:`MediaBrowser Client="JellySlides", Device="Web Client", DeviceId="${this.config.deviceId}", Version="1.0.0"`},o=JSON.stringify({Username:e,Pw:r||""}),c=await fetch(n,{method:"POST",headers:s,body:o});if(!c.ok)throw new Error("Authentication failed");return c.json()}explodeItemByImageType(e,r){const a=[],t=e.ImageTags||{},n=e.BackdropImageTags||[],s=e.ImageBlurHashes||{};let o=e.Name||"";if(r===u.season){const i=o.toLowerCase();(i.includes("season")||i.includes("special"))&&(o=e.SeriesName||o)}const c={id:e.Id,name:o,overview:e.Overview||"",type:e.Type};return r===u.audio?(t.Primary&&s.Primary&&a.push({...c,name:e.Album||e.Name,blurhash:s.Primary,overview:e.AlbumArtist||"",imageType:p.primary}),a):(t.Primary&&s.Primary&&a.push({...c,blurhash:s.Primary,imageType:p.primary}),t.Thumb&&s.Thumb&&a.push({...c,blurhash:s.Thumb,imageType:p.thumbnail}),n.length>0&&s.Backdrop&&a.push({...c,blurhash:s.Backdrop,imageType:p.backdrop}),a)}async getVideoIds({videoType:e,userId:r}){const{baseUrl:a,accessToken:t}=this.config,n=a.replace(/\/$/,""),s=new URL(`${n}/Users/${r}/Items`);s.searchParams.append("IncludeItemTypes",e),s.searchParams.append("Recursive","true"),s.searchParams.append("fields","Overview,PremiereDate,CommunityRating,RecursiveItemCount"),s.searchParams.append("api_key",t);const o=await fetch(s.toString());if(!o.ok)throw new Error("Failed to get video ids");const c=await o.json();if(e===u.boxset){const i=c.Items.map(h=>({id:h.Id}));return(await Promise.all(i.map(h=>this.fetchAndProcessChildItems({parentId:h,userId:r,videoType:e})))).flat()}if(e===u.audio){const i={};return c.Items.forEach(l=>{const h=l.AlbumId||l.Album||l.Id;i[h]=l}),Object.values(i).flatMap(l=>this.explodeItemByImageType(l,e))}return c.Items.flatMap(i=>this.explodeItemByImageType(i,e))}async fetchAndProcessChildItems({parentId:e,userId:r,videoType:a}){const{baseUrl:t,accessToken:n}=this.config,s=t.replace(/\/$/,""),o=new URL(`${s}/Users/${r}/Items`);o.searchParams.append("ParentId",e.id),o.searchParams.append("api_key",n),o.searchParams.append("fields","Overview,PremiereDate,CommunityRating,RecursiveItemCount");const c=await fetch(o.toString());return c.ok?(await c.json()).Items.flatMap(l=>this.explodeItemByImageType(l,a)):(console.error(`Failed to fetch child items for parent ${e.id}`),[])}}export{d as J};
