const m={backdrop:"Backdrop",primary:"Primary",thumbnail:"Thumb"},p={season:"Season",audio:"Audio",boxset:"BoxSet"};class I{config;constructor(s){this.config=s}getImageUrl(s,a,t=720,c=1280){const{baseUrl:o,accessToken:n}=this.config;return`${o.replace(/\/$/,"")}/Items/${s}/Images/${a}/?quality=${t}&fillHeight=${c}&fillWidth=${c}&format=jpg&api_key=${n}`}async getVideoDetails(s){const{baseUrl:a,accessToken:t}=this.config,o=`${a.replace(/\/$/,"")}/Items/${s}?api_key=${t}`,n=await fetch(o);if(!n.ok)throw new Error("Failed to get video details");return n.json()}async getUsers(){const{baseUrl:s,accessToken:a}=this.config,t=s.replace(/\/$/,"");if(a){const o=`${t}/Users?api_key=${a}`,n=await fetch(o);if(n.ok)return n.json()}const c=await fetch(`${t}/Users/Public`);if(c.ok)return c.json();throw new Error("Failed to fetch users")}async getViews(s){const{baseUrl:a,accessToken:t}=this.config,o=`${a.replace(/\/$/,"")}/Users/${s}/Views?api_key=${t}`,n=await fetch(o);if(!n.ok)throw new Error("Failed to fetch user views");return n.json()}async authenticateUser(s,a){const{baseUrl:t}=this.config,o=`${t.replace(/\/$/,"")}/Users/AuthenticateByName`,n={"Content-Type":"application/json",Authorization:`MediaBrowser Client="JellySlides", Device="Web Client", DeviceId="${this.config.deviceId}", Version="1.0.0"`},i=JSON.stringify({Username:s,Pw:a||""}),u=await fetch(o,{method:"POST",headers:n,body:i});if(!u.ok)throw new Error("Authentication failed");return u.json()}async getVideoIds({videoType:s,imageType:a,userId:t}){const{baseUrl:c,accessToken:o}=this.config,n=c.replace(/\/$/,""),i=new URL(`${n}/Users/${t}/Items`);i.searchParams.append("IncludeItemTypes",s),i.searchParams.append("Recursive","true"),i.searchParams.append("fields","Overview,PremiereDate,CommunityRating,RecursiveItemCount"),i.searchParams.append("api_key",o);const u=await fetch(i.toString());if(!u.ok)throw new Error("Failed to get video ids");const l=await u.json(),h=a===m.backdrop?"Backdrop":a===m.thumbnail?"Thumb":"Primary";if(s===p.boxset){const r=l.Items.map(d=>({id:d.Id}));return(await Promise.all(r.map(d=>this.fetchAndProcessChildItems({parentId:d,userId:t,videoType:s,imageType:a,hashtype:h})))).flat()}if(s===p.audio){const r={};return l.Items.forEach(e=>{const d=e.AlbumId||e.Album||e.Id;r[d]=e}),Object.values(r).filter(e=>e.ImageTags?.Primary||e.BackdropImageTags&&e.ImageBlurHashes?.[h]).map(e=>({id:e.ImageTags?.Primary||e.BackdropImageTags&&e.BackdropImageTags.length>0?e.Id:e.AlbumId,name:e.Album||e.Name,type:e.Type,overview:e.Overview||"",blurhash:e.ImageBlurHashes?.[h],imageType:a}))}return l.Items.filter(r=>r.ImageTags&&r.ImageBlurHashes&&r.ImageBlurHashes[h]).map(r=>{let e=r.Name||"";if(s===p.season){const d=e.toLowerCase();(d.includes("season")||d.includes("special"))&&(e=r.SeriesName||e)}return{id:r.Id,name:e,overview:r.Overview||"",type:r.Type,blurhash:r.ImageBlurHashes[h],imageType:a}})}async fetchAndProcessChildItems({parentId:s,userId:a,videoType:t,imageType:c,hashtype:o}){const{baseUrl:n,accessToken:i}=this.config,u=n.replace(/\/$/,""),l=new URL(`${u}/Users/${a}/Items`);l.searchParams.append("ParentId",s.id),l.searchParams.append("api_key",i),l.searchParams.append("fields","Overview,PremiereDate,CommunityRating,RecursiveItemCount");const h=await fetch(l.toString());if(!h.ok)return console.error(`Failed to fetch child items for parent ${s.id}`),[];const f=await h.json();let r=[];return t===p.boxset&&(r=f.Items.filter(e=>e.ImageTags?.Primary||e.BackdropImageTags&&e.ImageBlurHashes?.[o]).map(e=>({id:e.Id,name:e.Name,type:e.Type,overview:e.Overview||"",blurhash:e.ImageBlurHashes?.[o],imageType:c}))),r}}export{m as I,I as J};
